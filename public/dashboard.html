<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BitFreeze Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
header {background:#11162a;padding:15px;display:flex;justify-content:space-between;align-items:center;}
nav button {background:none;border:none;color:#aaa;margin:0 8px;font-size:16px;cursor:pointer;}
nav button.active {color:#00ffcc;}
section {display:none;padding:20px;}
section.active {display:block;}
.cards {display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px;}
.card {background:#141a33;border-radius:10px;padding:10px;}
.card img {width:100%;border-radius:8px;}
.card button {width:100%;margin-top:10px;padding:8px;background:#00ffcc;border:none;border-radius:5px;cursor:pointer;}
.balance-box {background:#141a33;padding:20px;border-radius:10px;margin-bottom:20px;}
table {width:100%;border-collapse:collapse;}
td, th {border-bottom:1px solid #333;padding:8px;}
input {width:100%;padding:10px;margin:5px 0;border-radius:5px;border:none;background:#0b0f1a;color:#fff;}
</style>
</head>
<body>

<header>
  <h2>BitFreeze</h2>
  <nav>
    <button onclick="showTab('home')" class="active">Home</button>
    <button onclick="showTab('fridges')">Fridges</button>
    <button onclick="showTab('offers')">Offers</button>
    <button onclick="showTab('withdraw')">Withdraw</button>
    <button onclick="showTab('profile')">Profile</button>
  </nav>
</header>

<!-- HOME -->
<section id="home" class="active">
  <div class="balance-box">
    <h3>Account Balance</h3>
    <h1 id="balance">KES 0</h1>
  </div>
  <canvas id="chart" height="200"></canvas>

  <h3>Trade History</h3>
  <table>
    <thead>
      <tr><th>Date</th><th>Action</th><th>Amount</th><th>Status</th></tr>
    </thead>
    <tbody id="history"></tbody>
  </table>
</section>

<!-- FRIDGES -->
<section id="fridges">
  <h2>Normal Fridges</h2>
  <div class="cards" id="normalFridges"></div>
</section>

<!-- OFFERS -->
<section id="offers">
  <h2>Offer Fridges</h2>
  <input id="offerCode" placeholder="Enter Offer Code">
  <button onclick="applyOffer()">Apply</button>
  <div class="cards" id="offerFridges"></div>
</section>

<!-- WITHDRAW -->
<section id="withdraw">
  <h2>Withdraw Funds</h2>
  <input id="wAmount" type="number" placeholder="Amount">
  <input id="wPhone" placeholder="MPESA Phone">
  <button onclick="withdraw()">Request Withdrawal</button>
</section>

<!-- PROFILE -->
<section id="profile">
  <h2>Profile</h2>
  <p><strong>Username:</strong> <span id="username"></span></p>
  <p><strong>Owned Fridges:</strong> <span id="ownedCount"></span></p>
  <p><strong>Total Earnings:</strong> KES <span id="totalEarning"></span></p>
</section>

<script>
// ================= UI =================
function showTab(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}

// ================= FRIDGES =================
const NORMAL_FRIDGES = [
  { id:'btc100', name:'Bitcoin 100', price:100, dailyEarn:5, img:'/images/btc100.jpg' },
  { id:'btc200', name:'Bitcoin 200', price:200, dailyEarn:10, img:'/images/btc200.jpg' },
  { id:'btc300', name:'Bitcoin 300', price:300, dailyEarn:15, img:'/images/btc300.jpg' },
  { id:'btc400', name:'Bitcoin 400', price:400, dailyEarn:20, img:'/images/btc400.jpg' },
  { id:'1ft', name:'Bitcoin 1ft', price:500, dailyEarn:25, img:'/images/fridge1ft.jpg' },
  { id:'2ft', name:'Bitcoin 2ft', price:1000, dailyEarn:55, img:'/images/fridge2ft.jpg' },
  { id:'3ft', name:'Bitcoin 3ft', price:2000, dailyEarn:100, img:'/images/fridge3ft.jpg' },
  { id:'4ft', name:'Bitcoin 4ft', price:4000, dailyEarn:150, img:'/images/fridge4ft.jpg' },
  { id:'5ft', name:'Bitcoin 5ft', price:6000, dailyEarn:250, img:'/images/fridge5ft.jpg' }
];

const OFFER_FRIDGES = [
  { id:'offer1', name:'游꾸 Offer 1', price:0, dailyEarn:0, img:'/images/offer1.jpg', locked:true },
  { id:'offer2', name:'游꾸 Offer 2', price:0, dailyEarn:0, img:'/images/offer2.jpg', locked:true },
  { id:'offer3', name:'游꾸 Offer 3', price:0, dailyEarn:0, img:'/images/offer3.jpg', locked:true },
  { id:'offer4', name:'游꾸 Offer 4', price:0, dailyEarn:0, img:'/images/offer4.jpg', locked:true },
  { id:'offer5', name:'游꾸 Offer 5', price:0, dailyEarn:0, img:'/images/offer5.jpg', locked:true },
  { id:'offer6', name:'游꾸 Offer 6', price:0, dailyEarn:0, img:'/images/offer6.jpg', locked:true },
  { id:'offer7', name:'游꾸 Offer 7', price:0, dailyEarn:0, img:'/images/offer7.jpg', locked:true },
  { id:'offer8', name:'游꾸 Offer 8', price:0, dailyEarn:0, img:'/images/offer8.jpg', locked:true }
];

// ================= FETCH USER =================
const token = localStorage.getItem('bf_token');
const HEADERS = {Authorization:'Bearer '+token};
if(!token) location.href='/login';

async function loadDashboard(){
  try{
    const res = await fetch('/api/me', {headers:HEADERS});
    const data = await res.json();
    const u = data.user;

    document.getElementById('balance').innerText = 'KES ' + u.earning;
    document.getElementById('username').innerText = u.name;
    document.getElementById('ownedCount').innerText = u.fridges.length;
    document.getElementById('totalEarning').innerText = u.earning;

    // Trade history
    const tbody = document.getElementById('history');
    tbody.innerHTML='';
    u.transactions.forEach(t=>{
      tbody.innerHTML += `<tr>
        <td>${new Date(t.date).toLocaleString()}</td>
        <td>${t.type}</td>
        <td>${t.amount}</td>
        <td>${t.status}</td>
      </tr>`;
    });

    // Normal fridges
    const nf = document.getElementById('normalFridges');
    nf.innerHTML='';
    NORMAL_FRIDGES.forEach(f=>{
      nf.innerHTML += `<div class="card">
        <img src="${f.img}">
        <h4>${f.name}</h4>
        <p>Price: KES ${f.price}</p>
        <p>Daily: KES ${f.dailyEarn}</p>
        <button onclick="buyFridge('${f.id}')">Buy</button>
      </div>`;
    });

    // Offer fridges
    const of = document.getElementById('offerFridges');
    of.innerHTML='';
    OFFER_FRIDGES.forEach(f=>{
      const unlocked = !f.locked;
      of.innerHTML += `<div class="card">
        <img src="${f.img}">
        <h4>${f.name}</h4>
        <button ${unlocked?'':'disabled'}>${unlocked?'Buy':'Locked'}</button>
      </div>`;
    });

    // Earnings chart (line candlestick style)
    const labels = u.transactions.map(t=>new Date(t.date).toLocaleTimeString());
    const dataPoints = u.transactions.map(t=>t.amount);
    const ctx = document.getElementById('chart').getContext('2d');
    if(window.earningsChart) window.earningsChart.destroy();
    window.earningsChart = new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label:'Earnings',data:dataPoints,borderColor:'#00ffcc',backgroundColor:'rgba(0,255,204,0.2)',fill:true,tension:0.3}]},
      options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}
    });

  }catch(err){console.error(err);}
}

loadDashboard();

// ================= BUY FRIDGE =================
async function buyFridge(id){
  const res = await fetch('/api/buy',{method:'POST',headers:HEADERS,body:JSON.stringify({fridgeId:id})});
  const data = await res.json();
  alert(data.message || data.error);
  loadDashboard();
}

// ================= OFFER CODE =================
async function applyOffer(){
  const code = document.getElementById('offerCode').value;
  const res = await fetch('/api/offercode',{method:'POST',headers:HEADERS,body:JSON.stringify({code})});
  const data = await res.json();
  alert(data.message || data.error);
  loadDashboard();
}

// ================= WITHDRAW =================
async function withdraw(){
  const amount = document.getElementById('wAmount').value;
  const phone = document.getElementById('wPhone').value;
  const res = await fetch('/api/withdraw',{method:'POST',headers:HEADERS,body:JSON.stringify({amount,phone})});
  const data = await res.json();
  alert(data.message || data.error);
  loadDashboard();
}
</script>
</body>
</html>
